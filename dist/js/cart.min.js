class Cookie{constructor(t){this.cookie=this.getCookie(t),this.user=document.querySelector(".user"),this.init()}init(){if(!this.cookie)return window.alert("你还没有登录,请先登录"),localStorage.setItem("url",location.href),void(location.href="../views/login.html");this.user.innerText=`欢迎您，${this.cookie}`,this.user.setAttribute("href","#")}getCookie(t){let e=document.cookie,a=e.split("; "),i={};if(a.forEach(t=>{t=t.split("=");i[t[0]]=t[1]}),!t)return i;for(var s in i)if(t==s)return i[s]}}new Cookie("user");class Cart{constructor(t){this.box=document.querySelector(t.name),this.getDataUrl=t.getDataUrl,this.removeDataUrl=t.removeDataUrl,this.clearDataUrl=t.clearDataUrl,this.changeDataUrl=t.changeDataUrl,this.init(),this.getData(this.getDataUrl,"GET")}init(){this.username=this.getCookie("user"),this.content=this.box.querySelector(".content"),this.species=this.box.querySelector(".species"),this.selectNum=this.box.querySelector(".selectNum"),this.selectPrice=this.box.querySelector(".selectPrice"),this.totalPrice=this.box.querySelector(".total"),this.allCheck=this.box.querySelector(".allCheck"),this.box.onclick=a=>{if((a=a||window.event).target.classList.contains("allCheck")&&(this.data.map(t=>(t.isSelect=a.target.checked?1:0,t)),localStorage.setItem("cartData",JSON.stringify(this.data)),this.render()),a.target.classList.contains("checks")){let e=a.target.getAttribute("goods-id");this.data.forEach(t=>{t.id==e&&(t.isSelect=a.target.checked?1:0)}),this.allCheck.checked=this.data.every(t=>1==t.isSelect),localStorage.setItem("cartData",JSON.stringify(this.data)),this.render()}if(a.target.classList.contains("btn-info"))return a.preventDefault(),confirm("hello ,"+this.username+" 确认买单吗")?(this.data.forEach(t=>{1==t.isSelect&&this.removeData(t.id)}),localStorage.setItem("cartData",JSON.stringify(this.data)),this.allCheck.checked=!1,void this.render()):void 0;var t;if(a.target.classList.contains("btn-warning")&&(confirm("确认清空购物车?")&&this.clearData(),this.allCheck.checked=!1),a.target.classList.contains("btn-danger")&&(a.preventDefault(),t=a.target.getAttribute("goods-id"),confirm("确认删除这条商品吗？")&&this.removeData(t)),a.target.classList.contains("reduce")){a.preventDefault();var e=a.target.getAttribute("goods-id"),i=+a.target.parentNode.nextElementSibling.firstElementChild.innerText;return 1==i?void 0:void this.changeData(this.username,e,--i)}a.target.classList.contains("add")&&(a.preventDefault(),e=a.target.getAttribute("goods-id"),i=+a.target.parentNode.previousElementSibling.firstElementChild.innerText,this.changeData(this.username,e,++i))}}getCookie(t){let e=document.cookie,a=e.split("; "),i={};if(a.forEach(t=>{t=t.split("=");i[t[0]]=t[1]}),!t)return i;for(var s in i)if(t==s)return i[s]}async getData(t,e){e=await new MyPromise({url:t,type:e,data:{username:this.username}});localStorage.setItem("cartData",e),this.data=JSON.parse(localStorage.getItem("cartData")),this.render()}render(){if(this.data=JSON.parse(localStorage.getItem("cartData")),this.species.innerText=this.data.length,this.count(),this.data.length){let e="";this.data.forEach(t=>{e+=`
            <div class="panel-body">
                 <div class="media" goodsid=${t.id}>
                     <div class='checkbox'><input type="checkbox" class='checks' goods-id=${t.id} ${1==t.isSelect?"checked":""}></div>
                     <div class="media-left">
                         <a href="#">
                             <img class="media-object"
                                 src="${t.img}"
                                 alt="">
                         </a>
                     </div>
                     <div class="media-body">
                         <p class="media-heading">${t.title}</p>
                         <p class='goods-sales'><span>${t.old_price}</span> <span>${t.sales}</span></p>
                         <p class='goods-price'><span>￥${t.now_price}</span><span>${t.cheap}</span></p>
                         <div class='panel-btns'>
                             <a href="#" class="btn btn-danger btn-sm" role="button" goods-id=${t.id}>删除商品</a>
                         </div>
                     </div>
                     <div class='media-right'>
                         <nav aria-label="Page navigation">
                             <ul class="pagination">
                                 <li><a href="#" class='reduce' goods-id=${t.id}>-</a></li>
                                 <li><a href="#">${t.goods_num}</a></li>
                                 <li><a href="#" class='add' goods-id=${t.id}>+</a></li>
                             </ul>
                         </nav>
                     </div>
                 </div>
             </div>
            `}),this.content.innerHTML=e}else this.content.innerHTML=`<div class="container">  
            <h1 style='text-align:center;'>Hello, ${this.username}</h1>
            <p style='text-align:center;font-size:20px;font-weight:600;color:#5BC0DE;'>购物车还没有商品,快去逛逛吧</p>
            <p style='text-align:center'><a class="btn btn-primary btn-default" href="../index.html" role="button">Go index！</a></p>
             </div>`}count(){let t=this.data.filter(t=>1==t.isSelect);var e=t.reduce((t,e)=>t+ +e.goods_num,0);this.selectNum.innerText=e;let a=t.reduce((t,e)=>t+e.goods_num*e.now_price,0);this.totalPrice.innerText=this.selectPrice.innerText=a.toFixed(2)}async removeData(e){var t=await new MyPromise({url:this.removeDataUrl,data:{username:this.username,goods_id:e}});(t=JSON.parse(t)).code&&(this.data=this.data.filter(t=>t.id!=e)),localStorage.setItem("cartData",JSON.stringify(this.data)),this.render()}async clearData(){var t=await new MyPromise({url:this.clearDataUrl,data:{username:this.username}});(t=JSON.parse(t)).code&&(localStorage.setItem("cartData",JSON.stringify([])),this.render())}async changeData(t,e,a){t=await new MyPromise({url:this.changeDataUrl,type:"POST",data:{username:t,goods_id:e,goods_num:a}});(t=JSON.parse(t)).code&&(this.data.forEach(t=>{t.goods_num=e==t.id?a:t.goods_num}),localStorage.setItem("cartData",JSON.stringify(this.data)),this.render())}}new Cart({name:"#main",getDataUrl:"../api/getCarData.php",removeDataUrl:"../api/removeCarData.php",clearDataUrl:"../api/clearCarData.php",changeDataUrl:"../api/updataCar.php"});